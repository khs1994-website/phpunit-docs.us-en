
<!DOCTYPE HTML>
<html lang="us-en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Fixtures · PHPUnit 英文文档</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-prism/prism-solarizedlight.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="incomplete-and-skipped-tests.html" />
    
    
    <link rel="prev" href="extending-phpunit.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://docs.khs1994.com" target="_blank" class="custom-link">Home</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="annotations.html">
            
                <a href="annotations.html">
            
                    
                    Annotations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="assertions.html">
            
                <a href="assertions.html">
            
                    
                    Assertions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="bibliography.html">
            
                <a href="bibliography.html">
            
                    
                    Bibliography
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="code-coverage-analysis.html">
            
                <a href="code-coverage-analysis.html">
            
                    
                    Code Coverage Analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="configuration.html">
            
                <a href="configuration.html">
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="copyright.html">
            
                <a href="copyright.html">
            
                    
                    Copyright
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="extending-phpunit.html">
            
                <a href="extending-phpunit.html">
            
                    
                    Extending Phpunit
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.9" data-path="fixtures.html">
            
                <a href="fixtures.html">
            
                    
                    Fixtures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="incomplete-and-skipped-tests.html">
            
                <a href="incomplete-and-skipped-tests.html">
            
                    
                    Incomplete And Skipped Tests
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="installation.html">
            
                <a href="installation.html">
            
                    
                    Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="organizing-tests.html">
            
                <a href="organizing-tests.html">
            
                    
                    Organizing Tests
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="risky-tests.html">
            
                <a href="risky-tests.html">
            
                    
                    Risky Tests
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="test-doubles.html">
            
                <a href="test-doubles.html">
            
                    
                    Test Doubles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="textui.html">
            
                <a href="textui.html">
            
                    
                    Textui
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="writing-tests-for-phpunit.html">
            
                <a href="writing-tests-for-phpunit.html">
            
                    
                    Writing Tests For Phpunit
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Fixtures</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="fixtures">Fixtures</h1>
<p>One of the most time-consuming parts of writing tests is writing the
code to set the world up in a known state and then return it to its
original state when the test is complete. This known state is called the
<em>fixture</em> of the test.</p>
<p>In <code>writing-tests-for-phpunit.examples.StackTest.php</code>, the fixture was
the array that is stored in the <code>$stack</code> variable. Most of the time,
though, the fixture will be more complex than a simple array, and the
amount of code needed to set it up will grow accordingly. The actual
content of the test gets lost in the noise of setting up the fixture.
This problem gets even worse when you write several tests with similar
fixtures. Without some help from the testing framework, we would have to
duplicate the code that sets up the fixture for each test we write.</p>
<p>PHPUnit supports sharing the setup code. Before a test method is run, a
template method called <code>setUp()</code> is invoked. <code>setUp()</code> is where you
create the objects against which you will test. Once the test method has
finished running, whether it succeeded or failed, another template
method called <code>tearDown()</code> is invoked. <code>tearDown()</code> is where you clean
up the objects against which you tested.</p>
<p>In <code>writing-tests-for-phpunit.examples.StackTest2.php</code> we used the
producer-consumer relationship between tests to share a fixture. This is
not always desired or even possible. <code>fixtures.examples.StackTest.php</code>
shows how we can write the tests of the <code>StackTest</code> in such a way that
not the fixture itself is reused but the code that creates it. First we
declare the instance variable, <code>$stack</code>, that we are going to use
instead of a method-local variable. Then we put the creation of the
<code>array</code> fixture into the <code>setUp()</code> method. Finally, we remove the
redundant code from the test methods and use the newly introduced
instance variable, <code>$this-&gt;stack</code>, instead of the method-local variable
<code>$stack</code> with the <code>assertSame()</code> assertion method.</p>
<pre class="language-"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>?php</span> <span class="token attr-name">declare(strict_types</span><span class="token attr-value"><span class="token punctuation">=</span>1);</span>
<span class="token attr-name">use</span> <span class="token attr-name">PHPUnit\Framework\TestCase;</span>

<span class="token attr-name">final</span> <span class="token attr-name">class</span> <span class="token attr-name">StackTest</span> <span class="token attr-name">extends</span> <span class="token attr-name">TestCase</span>
<span class="token attr-name">{</span>
    <span class="token attr-name">private</span> <span class="token attr-name">$stack;</span>

    <span class="token attr-name">protected</span> <span class="token attr-name">function</span> <span class="token attr-name"><span class="token namespace">setUp():</span></span> <span class="token attr-name">void</span>
    <span class="token attr-name">{</span>
        <span class="token attr-name">$this-</span><span class="token punctuation">&gt;</span></span>stack = [];
    }

    public function testEmpty(): void
    {
        $this-&gt;assertTrue(empty($this-&gt;stack));
    }

    public function testPush(): void
    {
        array_push($this-&gt;stack, &apos;foo&apos;);

        $this-&gt;assertSame(&apos;foo&apos;, $this-&gt;stack[count($this-&gt;stack)-1]);
        $this-&gt;assertFalse(empty($this-&gt;stack));
    }

    public function testPop(): void
    {
        array_push($this-&gt;stack, &apos;foo&apos;);

        $this-&gt;assertSame(&apos;foo&apos;, array_pop($this-&gt;stack));
        $this-&gt;assertTrue(empty($this-&gt;stack));
    }
}
</code></pre><p>The <code>setUp()</code> and <code>tearDown()</code> template methods are run once for each
test method (and on fresh instances) of the test case class.</p>
<p>In addition, the <code>setUpBeforeClass()</code> and <code>tearDownAfterClass()</code>
template methods are called before the first test of the test case class
is run and after the last test of the test case class is run,
respectively.</p>
<p>The example below shows all template methods that are available in a
test case class.</p>
<pre class="language-"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>?php</span> <span class="token attr-name">declare(strict_types</span><span class="token attr-value"><span class="token punctuation">=</span>1);</span>
<span class="token attr-name">use</span> <span class="token attr-name">PHPUnit\Framework\TestCase;</span>

<span class="token attr-name">final</span> <span class="token attr-name">class</span> <span class="token attr-name">TemplateMethodsTest</span> <span class="token attr-name">extends</span> <span class="token attr-name">TestCase</span>
<span class="token attr-name">{</span>
    <span class="token attr-name">public</span> <span class="token attr-name">static</span> <span class="token attr-name">function</span> <span class="token attr-name"><span class="token namespace">setUpBeforeClass():</span></span> <span class="token attr-name">void</span>
    <span class="token attr-name">{</span>
        <span class="token attr-name">fwrite(STDOUT,</span> <span class="token attr-name">__METHOD__</span> <span class="token attr-name">.</span> <span class="token attr-name">&quot;\n&quot;);</span>
    <span class="token attr-name">}</span>

    <span class="token attr-name">protected</span> <span class="token attr-name">function</span> <span class="token attr-name"><span class="token namespace">setUp():</span></span> <span class="token attr-name">void</span>
    <span class="token attr-name">{</span>
        <span class="token attr-name">fwrite(STDOUT,</span> <span class="token attr-name">__METHOD__</span> <span class="token attr-name">.</span> <span class="token attr-name">&quot;\n&quot;);</span>
    <span class="token attr-name">}</span>

    <span class="token attr-name">protected</span> <span class="token attr-name">function</span> <span class="token attr-name"><span class="token namespace">assertPreConditions():</span></span> <span class="token attr-name">void</span>
    <span class="token attr-name">{</span>
        <span class="token attr-name">fwrite(STDOUT,</span> <span class="token attr-name">__METHOD__</span> <span class="token attr-name">.</span> <span class="token attr-name">&quot;\n&quot;);</span>
    <span class="token attr-name">}</span>

    <span class="token attr-name">public</span> <span class="token attr-name">function</span> <span class="token attr-name"><span class="token namespace">testOne():</span></span> <span class="token attr-name">void</span>
    <span class="token attr-name">{</span>
        <span class="token attr-name">fwrite(STDOUT,</span> <span class="token attr-name">__METHOD__</span> <span class="token attr-name">.</span> <span class="token attr-name">&quot;\n&quot;);</span>
        <span class="token attr-name">$this-</span><span class="token punctuation">&gt;</span></span>assertTrue(true);
    }

    public function testTwo(): void
    {
        fwrite(STDOUT, __METHOD__ . &quot;\n&quot;);
        $this-&gt;assertTrue(false);
    }

    protected function assertPostConditions(): void
    {
        fwrite(STDOUT, __METHOD__ . &quot;\n&quot;);
    }

    protected function tearDown(): void
    {
        fwrite(STDOUT, __METHOD__ . &quot;\n&quot;);
    }

    public static function tearDownAfterClass(): void
    {
        fwrite(STDOUT, __METHOD__ . &quot;\n&quot;);
    }

    protected function onNotSuccessfulTest(Throwable $t): void
    {
        fwrite(STDOUT, __METHOD__ . &quot;\n&quot;);
        throw $t;
    }
}
</code></pre><p>$ phpunit TemplateMethodsTest PHPUnit .0 by Sebastian Bergmann and
contributors.</p>
<p>TemplateMethodsTest::setUpBeforeClass TemplateMethodsTest::setUp
TemplateMethodsTest::assertPreConditions TemplateMethodsTest::testOne
TemplateMethodsTest::assertPostConditions TemplateMethodsTest::tearDown
.TemplateMethodsTest::setUp TemplateMethodsTest::assertPreConditions
TemplateMethodsTest::testTwo TemplateMethodsTest::tearDown
TemplateMethodsTest::onNotSuccessfulTest
FTemplateMethodsTest::tearDownAfterClass</p>
<p>Time: 0 seconds, Memory: 5.25Mb</p>
<p>There was 1 failure:</p>
<p>1) TemplateMethodsTest::testTwo Failed asserting that
&lt;boolean:false&gt; is true. /home/sb/TemplateMethodsTest.php:30</p>
<p>FAILURES! Tests: 2, Assertions: 2, Failures: 1.</p>
<h2 id="more-setup-than-teardown">More setUp() than tearDown()</h2>
<p><code>setUp()</code> and <code>tearDown()</code> are nicely symmetrical in theory but not in
practice. In practice, you only need to implement <code>tearDown()</code> if you
have allocated external resources like files or sockets in <code>setUp()</code>. If
your <code>setUp()</code> just creates plain PHP objects, you can generally ignore
<code>tearDown()</code>. However, if you create many objects in your <code>setUp()</code>, you
might want to <code>unset()</code> the variables pointing to those objects in your
<code>tearDown()</code> so they can be garbage collected. The garbage collection of
test case objects is not predictable.</p>
<h2 id="variations">Variations</h2>
<p>What happens when you have two tests with slightly different setups?
There are two possibilities:</p>
<ul>
<li><p>If the <code>setUp()</code> code differs only slightly, move the code that</p>
<blockquote>
<p>differs from the <code>setUp()</code> code to the test method.</p>
</blockquote>
</li>
<li><p>If you really have a different <code>setUp()</code>, you need a different test</p>
<blockquote>
<p>case class. Name the class after the difference in the setup.</p>
</blockquote>
</li>
</ul>
<h2 id="sharing-fixture">Sharing Fixture</h2>
<p>There are few good reasons to share fixtures between tests, but in most
cases the need to share a fixture between tests stems from an unresolved
design problem.</p>
<p>A good example of a fixture that makes sense to share across several
tests is a database connection: you log into the database once and reuse
the database connection instead of creating a new connection for each
test. This makes your tests run faster.</p>
<p><code>fixtures.sharing-fixture.examples.DatabaseTest.php</code> uses the
<code>setUpBeforeClass()</code> and <code>tearDownAfterClass()</code> template methods to
connect to the database before the test case class&apos; first test and to
disconnect from the database after the last test of the test case,
respectively.</p>
<pre class="language-"><code>&lt;?php declare(strict_types=1);
use PHPUnit\Framework\TestCase;

final class DatabaseTest extends TestCase
{
    private static $dbh;

    public static function setUpBeforeClass(): void
    {
        self::$dbh = new PDO(&apos;sqlite::memory:&apos;);
    }

    public static function tearDownAfterClass(): void
    {
        self::$dbh = null;
    }
}
</code></pre><p>It cannot be emphasized enough that sharing fixtures between tests
reduces the value of the tests. The underlying design problem is that
objects are not loosely coupled. You will achieve better results solving
the underlying design problem and then writing tests using stubs (see
<code>test-doubles</code>), than by creating dependencies between tests at runtime
and ignoring the opportunity to improve your design.</p>
<h2 id="global-state">Global State</h2>
<p><a href="http://googletesting.blogspot.com/2008/05/tott-using-dependancy-injection-to.html" target="_blank">It is hard to test code that uses
singletons.</a>
The same is true for code that uses global variables. Typically, the
code you want to test is coupled strongly with a global variable and you
cannot control its creation. An additional problem is the fact that one
test&apos;s change to a global variable might break another test.</p>
<p>In PHP, global variables work like this:</p>
<ul>
<li><p>A global variable <code>$foo = &apos;bar&apos;;</code> is stored as</p>
<blockquote>
<p><code>$GLOBALS[&apos;foo&apos;] = &apos;bar&apos;;</code>.</p>
</blockquote>
</li>
<li><p>The <code>$GLOBALS</code> variable is a so-called <em>super-global</em> variable.</p>
</li>
<li><p>Super-global variables are built-in variables that are always</p>
<blockquote>
<p>available in all scopes.</p>
</blockquote>
</li>
<li><p>In the scope of a function or method, you may access the global</p>
<blockquote>
<p>variable <code>$foo</code> by either directly accessing <code>$GLOBALS[&apos;foo&apos;]</code> or
by using <code>global $foo;</code> to create a local variable with a
reference to the global variable.</p>
</blockquote>
</li>
</ul>
<p>Besides global variables, static attributes of classes are also part of
the global state.</p>
<p>Prior to version 6, by default, PHPUnit ran your tests in a way where
changes to global and super-global variables (<code>$GLOBALS</code>, <code>$_ENV</code>,
<code>$_POST</code>, <code>$_GET</code>, <code>$_COOKIE</code>, <code>$_SERVER</code>, <code>$_FILES</code>, <code>$_REQUEST</code>) do
not affect other tests.</p>
<p>As of version 6, PHPUnit does not perform this backup and restore
operation for global and super-global variables by default anymore. It
can be activated by using the <code>--globals-backup</code> option or setting
<code>backupGlobals=&quot;true&quot;</code> in the XML configuration file.</p>
<p>By using the <code>--static-backup</code> option or setting
<code>backupStaticAttributes=&quot;true&quot;</code> in the XML configuration file, this
isolation can be extended to static attributes of classes.</p>
<p>Note</p>
<p>The backup and restore operations for global variables and static class
attributes use <code>serialize()</code> and <code>unserialize()</code>.</p>
<p>Objects of some classes (e.g., <code>PDO</code>) cannot be serialized and the
backup operation will break when such an object is stored e.g. in the
<code>$GLOBALS</code> array.</p>
<p>The <code>@backupGlobals</code> annotation that is discussed in
<code>appendixes.annotations.backupGlobals</code> can be used to control the backup
and restore operations for global variables. Alternatively, you can
provide a list of global variables that are to be excluded from the
backup and restore operations like this</p>
<pre class="language-"><code>final class MyTest extends TestCase
{
    protected $backupGlobalsExcludeList = [&apos;globalVariable&apos;];

    // ...
}
</code></pre><p>Note</p>
<p>Setting the <code>$backupGlobalsExcludeList</code> property inside e.g. the
<code>setUp()</code> method has no effect.</p>
<p>The <code>@backupStaticAttributes</code> annotation discussed in
<code>appendixes.annotations.backupStaticAttributes</code> can be used to back up
all static property values in all declared classes before each test and
restore them afterwards.</p>
<p>It processes all classes that are declared at the time a test starts,
not only the test class itself. It only applies to static class
properties, not static variables within functions.</p>
<p>Note</p>
<p>The <code>@backupStaticAttributes</code> operation is executed before a test
method, but only if it is enabled. If a static value was changed by a
previously executed test that did not have <code>@backupStaticAttributes</code>
enabled, then that value will be backed up and restored &#x2014; not the
originally declared default value. PHP does not record the originally
declared default value of any static variable.</p>
<p>The same applies to static properties of classes that were newly
loaded/declared within a test. They cannot be reset to their originally
declared default value after the test, since that value is unknown.
Whichever value is set will leak into subsequent tests.</p>
<p>For unit tests, it is recommended to explicitly reset the values of
static properties under test in your <code>setUp()</code> code instead (and ideally
also <code>tearDown()</code>, so as to not affect subsequently executed tests).</p>
<p>You can provide a list of static attributes that are to be excluded from
the backup and restore operations:</p>
<pre class="language-"><code>final class MyTest extends TestCase
{
    protected $backupStaticAttributesExcludeList = [
        &apos;className&apos; =&gt; [&apos;attributeName&apos;]
    ];

    // ...
}
</code></pre><p>Note</p>
<p>Setting the <code>$backupStaticAttributesExcludeList</code> property inside e.g.
the <code>setUp()</code> method has no effect.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="extending-phpunit.html" class="navigation navigation-prev " aria-label="Previous page: Extending Phpunit">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="incomplete-and-skipped-tests.html" class="navigation navigation-next " aria-label="Next page: Incomplete And Skipped Tests">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Fixtures","level":"1.9","depth":1,"next":{"title":"Incomplete And Skipped Tests","level":"1.10","depth":1,"path":"incomplete-and-skipped-tests.md","ref":"incomplete-and-skipped-tests.md","articles":[]},"previous":{"title":"Extending Phpunit","level":"1.8","depth":1,"path":"extending-phpunit.md","ref":"extending-phpunit.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-highlight","-livereload","prism"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prismjs/themes/prism-solarizedlight.css"]},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"PHPUnit 英文文档","language":"us-en","links":{"sidebar":{"Home":"https://docs.khs1994.com"}},"gitbook":"*"},"file":{"path":"fixtures.md","mtime":"2021-05-20T01:13:25.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-05-20T01:13:58.148Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

